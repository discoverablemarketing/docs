{"openapi":"3.1.0","info":{"title":"ChatAds API","description":"\nAffiliate link insertion API for AI chatbot conversations.\n\nChatAds analyzes messages to identify product mentions and returns relevant affiliate links that can be inserted into AI responses.\n\n## Features\n- **Keyword Extraction**: AI-powered product keyword detection\n- **Affiliate Matching**: Amazon PA-API with fallback sources\n- **Rate Limiting**: Per-team minute/daily/monthly quotas\n- **Geo Targeting**: Country-based filtering and localization\n\n## Authentication\nAll endpoints require an API key passed in the `X-API-Key` header.\nObtain your API key from [app.getchatads.com](https://app.getchatads.com/settings/api-keys).\n\n## Rate Limits\nRate limits are applied per team and shared across all API keys:\n- **Free tier**: 100 requests/month\n- **Paid tiers**: Higher limits based on plan\n","termsOfService":"https://getchatads.com/terms","contact":{"name":"ChatAds Support","url":"https://getchatads.com/","email":"support@getchatads.com"},"license":{"name":"Proprietary","url":"https://getchatads.com/terms"},"version":"1.0.0"},"paths":{"/admin/cache/team/{team_id}":{"delete":{"tags":["admin"],"summary":"Flush team cache","description":"Clears cached data for a specific team. Called by Supabase edge function when team settings change.","operationId":"flush_team_cache_admin_cache_team__team_id__delete","parameters":[{"name":"team_id","in":"path","required":true,"schema":{"type":"string","title":"Team Id"}},{"name":"x-admin-key","in":"header","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"X-Admin-Key"}}],"responses":{"200":{"description":"Cache flushed successfully","content":{"application/json":{"schema":{"$ref":"#/components/schemas/TeamCacheFlushResponse"}}}},"401":{"description":"Missing admin API key"},"403":{"description":"Invalid admin API key"},"503":{"description":"Cache service not available"},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/admin/cache/all":{"delete":{"tags":["admin"],"summary":"Flush all cache","description":"Clears entire API user cache. WARNING: Causes Supabase query spike as all users re-fetch data. Only use in emergencies.","operationId":"flush_all_cache_admin_cache_all_delete","parameters":[{"name":"confirm","in":"query","required":false,"schema":{"type":"boolean","default":false,"title":"Confirm"}},{"name":"x-admin-key","in":"header","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"X-Admin-Key"}}],"responses":{"200":{"description":"All cache flushed successfully","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AllCacheFlushResponse"}}}},"400":{"description":"Missing confirmation flag"},"401":{"description":"Missing admin API key"},"403":{"description":"Invalid admin API key"},"503":{"description":"Cache service not available"},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/admin/cache/stats":{"get":{"tags":["admin"],"summary":"Get cache statistics","description":"Returns cache metrics including size, hit rate, and evictions. Useful for monitoring cache performance.","operationId":"get_cache_stats_admin_cache_stats_get","parameters":[{"name":"x-admin-key","in":"header","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"X-Admin-Key"}}],"responses":{"200":{"description":"Cache statistics retrieved successfully","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CacheStatsResponse"}}}},"401":{"description":"Missing admin API key"},"403":{"description":"Invalid admin API key"},"503":{"description":"Cache service not available"},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/healthz":{"get":{"tags":["Health"],"summary":"Liveness probe","description":"Returns 200 if the container is running. Used by load balancers.","operationId":"healthz_healthz_get","responses":{"200":{"description":"Container is alive","content":{"application/json":{"schema":{},"example":{"status":"ok"}}}}}}},"/readyz":{"get":{"tags":["Health"],"summary":"Readiness probe","description":"Returns 200 only after startup completes. Returns 503 if not ready.","operationId":"readyz_readyz_get","responses":{"200":{"description":"Service is ready","content":{"application/json":{"schema":{},"example":{"status":"ready"}}}},"503":{"description":"Service not ready","content":{"application/json":{"example":{"detail":"Service not ready"}}}}}}},"/v1/chatads/messages":{"post":{"tags":["Affiliate"],"summary":"Analyze message for affiliate opportunities","description":"Analyzes a user message to extract product keywords and return relevant affiliate links.\n\n**Processing Pipeline:**\n1. Validates API key and rate limits\n2. Checks geo-restrictions and blocked keywords\n3. Extracts product keywords using AI\n4. Resolves affiliate links via affiliate partners\n5. Returns structured response with affiliate data\n\n**Quality Levels** (via `message_analysis` field):\n- `fast`: Lightweight extraction (~50ms)\n- `balanced`: Hybrid approach (~150ms)\n- `thorough`: Deeper extraction (~300ms)","operationId":"chatads_messages_v1_chatads_messages_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/FunctionItem"}}},"required":true},"responses":{"200":{"description":"Successful analysis","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ChatAdsResponse-Input"}}}},"400":{"description":"Invalid request (empty message, invalid format)"},"401":{"description":"Missing or invalid API key"},"403":{"description":"API key disabled or unauthorized"},"422":{"description":"Content blocked (keyword or geo restriction)"},"429":{"description":"Rate limit exceeded"},"500":{"description":"Internal server error"},"503":{"description":"Service temporarily unavailable"}},"security":[{"APIKeyHeader":[]}]}}},"components":{"schemas":{"AllCacheFlushResponse":{"properties":{"success":{"type":"boolean","title":"Success","description":"Whether the operation succeeded"},"flushed_entries":{"type":"integer","title":"Flushed Entries","description":"Number of cache entries removed"},"message":{"type":"string","title":"Message","description":"Human-readable result message"},"warning":{"type":"string","title":"Warning","description":"Warning about potential impact"}},"type":"object","required":["success","flushed_entries","message","warning"],"title":"AllCacheFlushResponse","description":"Response from flush-all cache operation.","example":{"flushed_entries":47,"message":"All cache flushed. Expect Supabase query spike as users re-fetch data.","success":true,"warning":"Monitor Supabase dashboard for increased load"}},"CacheStatsResponse":{"properties":{"success":{"type":"boolean","title":"Success","description":"Whether the operation succeeded"},"cache_stats":{"additionalProperties":true,"type":"object","title":"Cache Stats","description":"Cache statistics including size, hits, misses"}},"type":"object","required":["success","cache_stats"],"title":"CacheStatsResponse","description":"Response containing cache statistics.","example":{"cache_stats":{"hit_rate":0.974,"hits":15847,"misses":423,"size":142},"success":true}},"ChatAdsAd":{"properties":{"product":{"type":"string","title":"Product"},"link":{"type":"string","title":"Link"},"message":{"type":"string","title":"Message"},"category":{"type":"string","title":"Category"}},"type":"object","required":["product","link","message","category"],"title":"ChatAdsAd","example":{"category":"electronics","link":"https://example.com/noise-cancelling-headphones","message":"Block out distractions with premium ANC headphones.","product":"Noise-Cancelling Headphones"}},"ChatAdsData":{"properties":{"matched":{"type":"boolean","title":"Matched"},"filled":{"type":"boolean","title":"Filled","default":false},"ad":{"anyOf":[{"$ref":"#/components/schemas/ChatAdsAd"},{"type":"null"}]},"keyword":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Keyword"},"reason":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Reason"},"intent_score":{"anyOf":[{"type":"number","maximum":1.0,"minimum":0.0},{"type":"null"}],"title":"Intent Score","description":"Normalized purchase intent score (0.0 to 1.0)."},"intent_level":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Intent Level","description":"Categorical intent level: 'high', 'medium', 'low', or 'very_low'."},"min_intent_required":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Min Intent Required","description":"Minimum intent level that was required (shown when filtered)."}},"type":"object","required":["matched"],"title":"ChatAdsData","example":{"ad":{"category":"electronics","link":"https://example.com/noise-cancelling-headphones","message":"Block out distractions with premium ANC headphones.","product":"Noise-Cancelling Headphones"},"filled":true,"keyword":"noise-cancelling headphones","matched":true}},"ChatAdsError":{"properties":{"code":{"type":"string","title":"Code"},"message":{"type":"string","title":"Message"},"details":{"additionalProperties":true,"type":"object","title":"Details"}},"type":"object","required":["code","message"],"title":"ChatAdsError","example":{"code":"DAILY_QUOTA_EXCEEDED","details":{"daily_limit":100,"daily_usage":120,"plan":"free"},"message":"Daily request limit exceeded. You've used 120 of 100 requests for today."}},"ChatAdsMeta":{"properties":{"request_id":{"type":"string","title":"Request Id"},"country":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Country"},"language":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Language"},"extraction_method":{"anyOf":[{"type":"string","enum":["llm","nlp","skip"]},{"type":"null"}],"title":"Extraction Method"},"message_analysis_used":{"anyOf":[{"type":"string","enum":["fast","balanced","thorough","skip"]},{"type":"null"}],"title":"Message Analysis Used"},"fill_priority_used":{"anyOf":[{"type":"string","enum":["speed","coverage","skip"]},{"type":"null"}],"title":"Fill Priority Used"},"min_intent_used":{"anyOf":[{"type":"string","enum":["any","low","medium","high"]},{"type":"null"}],"title":"Min Intent Used","description":"The min_intent level used for this request."},"usage":{"anyOf":[{"$ref":"#/components/schemas/UsageInfo"},{"type":"null"}]}},"additionalProperties":true,"type":"object","required":["request_id"],"title":"ChatAdsMeta","example":{"country":"US","extraction_method":"llm","fill_priority_used":"coverage","language":"en","message_analysis_used":"balanced","request_id":"d6a8f6f2-3b5a-4f0a-81ab-1b4a4c9dd5ea","timing_ms":{"response_total":120.4},"usage":{"daily_limit":100,"daily_requests":20,"free_tier_limit":100,"free_tier_remaining":0,"is_free_tier":true,"monthly_requests":250}}},"ChatAdsResponse-Input":{"properties":{"success":{"type":"boolean","title":"Success"},"data":{"anyOf":[{"$ref":"#/components/schemas/ChatAdsData"},{"type":"null"}]},"error":{"anyOf":[{"$ref":"#/components/schemas/ChatAdsError"},{"type":"null"}]},"meta":{"$ref":"#/components/schemas/ChatAdsMeta"}},"type":"object","required":["success","meta"],"title":"ChatAdsResponse","examples":[{"data":{"ad":{"category":"electronics","link":"https://example.com/noise-cancelling-headphones","message":"Block out distractions with premium ANC headphones.","product":"Noise-Cancelling Headphones"},"filled":true,"keyword":"noise-cancelling headphones","matched":true},"meta":{"country":"US","extraction_method":"llm","fill_priority_used":"coverage","language":"en","message_analysis_used":"balanced","request_id":"d6a8f6f2-3b5a-4f0a-81ab-1b4a4c9dd5ea","timing_ms":{"response_total":120.4},"usage":{"daily_limit":100,"daily_requests":20,"free_tier_limit":100,"free_tier_remaining":0,"is_free_tier":true,"monthly_requests":250}},"success":true},{"error":{"code":"DAILY_QUOTA_EXCEEDED","details":{"daily_limit":100,"daily_usage":120,"plan":"free"},"message":"Daily request limit exceeded. You've used 120 of 100 requests for today."},"meta":{"country":"US","extraction_method":"llm","fill_priority_used":"coverage","language":"en","message_analysis_used":"balanced","request_id":"d6a8f6f2-3b5a-4f0a-81ab-1b4a4c9dd5ea","timing_ms":{"response_total":120.4},"usage":{"daily_limit":100,"daily_requests":20,"free_tier_limit":100,"free_tier_remaining":0,"is_free_tier":true,"monthly_requests":250}},"success":false}]},"ChatAdsResponse-Output":{"properties":{"success":{"type":"boolean","title":"Success"},"data":{"anyOf":[{"$ref":"#/components/schemas/ChatAdsData"},{"type":"null"}]},"error":{"anyOf":[{"$ref":"#/components/schemas/ChatAdsError"},{"type":"null"}]},"meta":{"$ref":"#/components/schemas/ChatAdsMeta"}},"type":"object","required":["success","meta"],"title":"ChatAdsResponse","examples":[{"data":{"ad":{"category":"electronics","link":"https://example.com/noise-cancelling-headphones","message":"Block out distractions with premium ANC headphones.","product":"Noise-Cancelling Headphones"},"filled":true,"keyword":"noise-cancelling headphones","matched":true},"meta":{"country":"US","extraction_method":"llm","fill_priority_used":"coverage","language":"en","message_analysis_used":"balanced","request_id":"d6a8f6f2-3b5a-4f0a-81ab-1b4a4c9dd5ea","timing_ms":{"response_total":120.4},"usage":{"daily_limit":100,"daily_requests":20,"free_tier_limit":100,"free_tier_remaining":0,"is_free_tier":true,"monthly_requests":250}},"success":true},{"error":{"code":"DAILY_QUOTA_EXCEEDED","details":{"daily_limit":100,"daily_usage":120,"plan":"free"},"message":"Daily request limit exceeded. You've used 120 of 100 requests for today."},"meta":{"country":"US","extraction_method":"llm","fill_priority_used":"coverage","language":"en","message_analysis_used":"balanced","request_id":"d6a8f6f2-3b5a-4f0a-81ab-1b4a4c9dd5ea","timing_ms":{"response_total":120.4},"usage":{"daily_limit":100,"daily_requests":20,"free_tier_limit":100,"free_tier_remaining":0,"is_free_tier":true,"monthly_requests":250}},"success":false}]},"FunctionItem":{"properties":{"message":{"type":"string","maxLength":5000,"minLength":1,"title":"Message","description":"Message to analyze. Required."},"ip":{"anyOf":[{"type":"string","maxLength":64},{"type":"null"}],"title":"Ip","description":"Client IP address for geo-detection (max 64 characters)."},"country":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Country","description":"ISO 3166-1 alpha-2 country code for geo-targeting."},"message_analysis":{"type":"string","enum":["fast","balanced","thorough"],"title":"Message Analysis","description":"Controls keyword extraction method. 'fast' uses a lightweight model (~50ms), 'balanced' (default) and 'thorough' use deeper extraction (~200-300ms).","default":"balanced"},"fill_priority":{"type":"string","enum":["speed","coverage"],"title":"Fill Priority","description":"Controls URL resolution fallback behavior. 'speed' skips Serper fallback, 'coverage' (default) uses full resolution chain (PA-API -> Serper -> no match).","default":"coverage"},"min_intent":{"type":"string","enum":["any","low","medium","high"],"title":"Min Intent","description":"Minimum purchase intent level required for affiliate resolution. 'any' = no filtering, 'low' (default) = filter garbage, 'medium' = balanced quality/fill, 'high' = premium only.","default":"low"},"skip_message_analysis":{"anyOf":[{"type":"boolean"},{"type":"null"}],"title":"Skip Message Analysis","description":"Skip keyword extraction and use message content directly as search query. When true, bypasses message_analysis, fill_priority, and min_intent settings.","default":false}},"additionalProperties":false,"type":"object","required":["message"],"title":"FunctionItem","description":"Request payload for message analysis.","example":{"message":"What's the best yoga mat for beginners?","country":"US","message_analysis":"balanced","fill_priority":"coverage","min_intent":"low"}},"HTTPValidationError":{"properties":{"detail":{"items":{"$ref":"#/components/schemas/ValidationError"},"type":"array","title":"Detail"}},"type":"object","title":"HTTPValidationError"},"TeamCacheFlushResponse":{"properties":{"success":{"type":"boolean","title":"Success","description":"Whether the operation succeeded"},"team_id":{"type":"string","title":"Team Id","description":"Team UUID that was flushed"},"flushed_entries":{"type":"integer","title":"Flushed Entries","description":"Number of cache entries removed"},"message":{"type":"string","title":"Message","description":"Human-readable result message"}},"type":"object","required":["success","team_id","flushed_entries","message"],"title":"TeamCacheFlushResponse","description":"Response from team cache flush operation.","example":{"flushed_entries":3,"message":"Cache flushed for team 550e8400-e29b-41d4-a716-446655440000. Next request will fetch fresh data from database.","success":true,"team_id":"550e8400-e29b-41d4-a716-446655440000"}},"UsageInfo":{"properties":{"monthly_requests":{"type":"integer","title":"Monthly Requests"},"free_tier_limit":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Free Tier Limit"},"free_tier_remaining":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Free Tier Remaining"},"is_free_tier":{"type":"boolean","title":"Is Free Tier"},"daily_requests":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Daily Requests"},"daily_limit":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Daily Limit"}},"type":"object","required":["monthly_requests","free_tier_limit","free_tier_remaining","is_free_tier"],"title":"UsageInfo","description":"Usage information returned in API responses.\n\nCHA-326: Removed minute_requests and minute_limit (only daily/monthly limits now).","example":{"daily_limit":100,"daily_requests":20,"free_tier_limit":100,"free_tier_remaining":0,"is_free_tier":true,"monthly_requests":250}},"ValidationError":{"properties":{"loc":{"items":{"anyOf":[{"type":"string"},{"type":"integer"}]},"type":"array","title":"Location"},"msg":{"type":"string","title":"Message"},"type":{"type":"string","title":"Error Type"}},"type":"object","required":["loc","msg","type"],"title":"ValidationError"}},"securitySchemes":{"APIKeyHeader":{"type":"apiKey","description":"API key for authentication. Obtain from https://app.getchatads.com/settings/api-keys","in":"header","name":"X-API-Key"}}},"tags":[{"name":"Affiliate","description":"Message analysis and affiliate link matching"},{"name":"Health","description":"Health check and readiness probes"},{"name":"Admin","description":"Administrative operations (requires admin API key)"}]}